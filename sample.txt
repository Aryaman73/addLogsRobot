*** Settings ***
Test Timeout      10 minutes
Suite Setup       perform suite setup
Suite Teardown    quit application
Library           workflows.lab_report.lab_report.LabReport
Library           Collections
Library           workflows.lab_categorization.lab_categorization_keyword.Keyword_lab_categorization
Library           workflows.labs_messaging.lab_message_keyword.Keyword_labs_and_messaging
Library           lib.common.pss_record_new.PssRecordWindow
Library           workflows.records.records.records
Library           lib.common.pss_record_new.PssRecordWindow
Library           Collections
*** Variables ***
${doctor name}      Unrecognized Doctors
${accesion number}  20:TB2802:C00610R^TBRH
${file path}    4233_Ferritin.hl7
${lab not imported}     True
*** Test Cases ***
Manual Ferritin Test
    import a lab      ${file path}
    view lab report   ${doctor name}  ${accesion number}
    ${required line}    read lab
    should contain  ${required line}    Ferritin    ignore_case=True
    delete lab report
Patient Note Ferritin Test
    import a lab      ${file path}
    view lab report   ${doctor name}  ${accesion number}
    match patient     Yeo   2899
    post report
    set global variable  ${lab not imported}      False
    search a patient from records   2899
    verify lab posted on patient chart  Ferritin
#    delete all notes for current day
Patient Note Source Message Ferritin Test
    run keyword if  ${lab not imported}==${True}    import and post the lab         #Why is this always running?
    open posting preview   ${accesion number}
    ${required line}    read lab
    should contain  ${required line}    Ferritin    ignore_case=True
#    delete all notes for current day
*** Keywords ***
perform suite setup
    #attach to aut
    set library search order    workflows.lab_categorization.lab_categorization_keyword.Keyword_lab_categorization
    Launch Application
    Login As     jmk    jmk1
import a lab
    [Arguments]    ${file path}
    set library search order    workflows.lab_categorization.lab_categorization_keyword.Keyword_lab_categorization
    ${lab path}    get full path of lab file    ${file path}    lab_files
    Import Lab    ${lab path}
read lab
    ${required line}   Get Nth Line Whitebox    4  #Ferritin appears in the 5th line of 4233.hl7 in Lab Posting Preview
    [Return]  ${required line}
import and post the lab
        import a lab      ${file path}
        view lab report   ${doctor name}  ${accesion number}
        match patient     Yeo   2899
        post report
        search a patient from records   2899
quit application
    workflows.lab_categorization.lab_categorization_keyword.Keyword_lab_categorization.quit_pss